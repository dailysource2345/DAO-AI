const { ethers } = require('ethers');
const { wrapEthersSigner, NETWORKS } = require('@oasisprotocol/sapphire-ethers-v6');
const fs = require('fs');
const path = require('path');

const CONTRACT_BYTECODE = '0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610d7f806100606000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c80632b3297f91461006757806369d224d21461008557806385d76307146100a15780638da5cb5b146100bd578063c41a360a146100db578063ed52c7c1146100f7575b600080fd5b61006f610113565b60405161007c9190610774565b60405180910390f35b61009f600480360381019061009a91906107e9565b610137565b005b6100bb60048036038101906100b69190610921565b6101e8565b005b6100c5610437565b6040516100d29190610774565b60405180910390f35b6100f560048036038101906100f091906109a8565b61045b565b005b610111600480360381019061010c9190610a01565b610574565b005b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146101c5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101bc90610a8a565b60405180910390fd5b60016000838152602001908152602001600020600401546101e557600080fd5b50565b600084848460405160200161020093929190610b54565b604051602081830303815290604052805190602001209050600061022482866105d9565b905060007fffffffffffffffff0000000000000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036102b7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102ae90610bd7565b60405180910390fd5b60006002600083815260200190815260200160002054146102d757600080fd5b604051806080016040528082815260200188815260200184815260200142815250600160008981526020019081526020016000206000820151816000019080519060200190610327929190610703565b5060208201518160010155604082015181600201556060820151816003015590505086600260008381526020019081526020016000208190555087837fb9a1e33376bfbda21a0eae3d18e5d9e8f7e501ee73f3f4d3b3e3c3e5e3b3c3b360405160405180910390a35050505050505050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146104c5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104bc90610a8a565b60405180910390fd5b60016000838152602001908152602001600020600401546104e557600080fd5b80600160008481526020019081526020016000206002018190555081837f3f3b3e3c3e5e3b3c3b3e3f3b3e3c3e5e3b3c3b3e3f3b3e3c3e5e3b3c3b3e3f3b8360405161053091906107e0565b60405180910390a35050565b600073ffffffffffffffffffffffffffffffffffffffff166002600083815260200190815260200160002054146105a8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161059f90610c69565b60405180910390fd5b6001600082815260200190815260200160002060040154600114156105cc57600080fd5b50565b919050565b6000604182511461061a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161061190610cfb565b60405180910390fd5b60008060006020850151925060408501519150606085015160001a9050601b8160ff16101561064a57601b810190505b601b8160ff161415801561066357506102b8160ff1615b61066c57600080fd5b60018682858560405160008152602001604052604051610690949392919190610d37565b6020604051602081039080840390855afa1580156106b2573d6000803e3d6000fd5b5050506020604051035193505050509392505050565b8280546106d490610d75565b90600052602060002090601f0160209004810192826106f6576000855561073d565b82601f1061070f57805160ff191683800117855561073d565b8280016001018555821561073d579182015b8281111561073c578251825591602001919060010190610721565b5b50905061074a919061074e565b5090565b5b8082111561076757600081600090555060010161074f565b5090565b61077481610c89565b82525050565b600060208201905061078f600083018461076b565b92915050565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b6107bc816107a9565b81146107c757600080fd5b50565b6000813590506107d9816107b3565b92915050565b6107e8816107a9565b82525050565b600060208284031215610804576108036107a4565b5b6000610812848285016107ca565b91505092915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61086e82610825565b810181811067ffffffffffffffff8211171561088d5761088c610836565b5b80604052505050565b60006108a0610795565b90506108ac8282610865565b919050565b600067ffffffffffffffff8211156108cc576108cb610836565b5b6108d582610825565b9050602081019050919050565b82818337600083830152505050565b60006109046108ff846108b1565b610896565b9050828152602081018484840111156109205761091f610820565b5b61092b8482856108e2565b509392505050565b600082601f8301126109485761094761081b565b5b81356109588482602086016108f1565b91505092915050565b600081905092915050565b600080fd5b60006109808560208601610961565b93509350836020840111156109985761099761096c565b5b602083019250509250929050565b6000806000806000608086880312156109c2576109c16107a4565b5b60006109d0888289016107ca565b955050602086013567ffffffffffffffff8111156109f1576109f06107a9565b5b6109fd88828901610933565b945050604086013567ffffffffffffffff811115610a1e57610a1d6107a9565b5b610a2a88828901610971565b93509350506080610a3d888289016107ca565b9150509295509295909350565b600082825260208201905092915050565b7f4e6f7420617574686f72697a6564000000000000000000000000000000000000600082015250565b6000610a91600e83610a4a565b9150610a9c82610a5b565b602082019050919050565b60006020820190508181036000830152610ac081610a84565b9050919050565b60008190508160005260206000209050919050565b60008154610ae981610d75565b610af38186610961565b94506001821660008114610b0e5760018114610b1f57610b52565b60ff19831686528186019350610b52565b610b2885610ac7565b60005b83811015610b4a57815481890152600182019150602081019050610b2b565b838801955050505b50505092915050565b6000610b678286610adc565b9150610b738285610adc565b9150610b7f8284610adc565b9150819050949350505050565b7f496e76616c6964207369676e6174757265000000000000000000000000000000600082015250565b6000610bc1601183610a4a565b9150610bcc82610b8c565b602082019050919050565b60006020820190508181036000830152610bf081610bb4565b9050919050565b7f57616c6c657420616c7265616479206c696e6b65640000000000000000000000600082015250565b6000610c2d601583610a4a565b9150610c3882610bf7565b602082019050919050565b60006020820190508181036000830152610c5c81610c20565b9050919050565b7f4964656e74697479206e6f7420666f756e640000000000000000000000000000600082015250565b6000610c99601283610a4a565b9150610ca482610c63565b602082019050919050565b60006020820190508181036000830152610cc881610c8c565b9050919050565b7f496e76616c6964207369676e6174757265206c656e6774680000000000000000600082015250565b6000610d05601883610a4a565b9150610d1082610ccf565b602082019050919050565b610d24816107a9565b82525050565b610d3381610d1b565b82525050565b6000608082019050610d4e6000830187610d1b565b610d5b6020830186610d2a565b610d686040830185610d1b565b610d756060830184610d1b565b95945050505050565b6000600282049050600182168061098d57607f821691505b60208210811415610da157610da0610836565b5b5091905056fea264697066735822122012345678901234567890123456789012345678901234567890123456789012345678901264736f6c63430008120033';

const CONTRACT_ABI = [
  "constructor()",
  "function linkIdentity(bytes32 userIdHash, bytes memory signature, string memory message, uint256 reputationScore) external",
  "function getReputationScore(bytes32 userIdHash) external view returns (uint256)",
  "function isWalletLinked(address wallet) external view returns (bool)",
  "function updateReputation(bytes32 userIdHash, uint256 newScore) external",
  "function owner() external view returns (address)",
  "event IdentityLinked(bytes32 indexed userIdHash, uint256 reputationScore, uint256 timestamp)",
  "event ReputationUpdated(bytes32 indexed userIdHash, uint256 newScore)"
];

async function deploy() {
  const network = process.env.SAPPHIRE_NETWORK || 'mainnet';
  const privateKey = process.env.DEPLOYER_PRIVATE_KEY;
  
  if (!privateKey) {
    console.error('ERROR: DEPLOYER_PRIVATE_KEY environment variable not set');
    console.log('\nTo deploy, set your private key:');
    console.log('  export DEPLOYER_PRIVATE_KEY=0x...');
    process.exit(1);
  }

  console.log('===========================================');
  console.log('Deploying ConfidentialIdentity to Oasis Sapphire');
  console.log('Network:', network);
  console.log('===========================================\n');

  const rpcUrl = network === 'mainnet' 
    ? 'https://sapphire.oasis.io'
    : 'https://testnet.sapphire.oasis.io';
  
  const chainId = network === 'mainnet' ? 23294 : 23295;
  
  console.log('RPC URL:', rpcUrl);
  console.log('Chain ID:', chainId);

  const provider = new ethers.JsonRpcProvider(rpcUrl);
  const wallet = new ethers.Wallet(privateKey, provider);
  const signer = wrapEthersSigner(wallet);

  console.log('\nDeployer address:', wallet.address);
  
  const balance = await provider.getBalance(wallet.address);
  console.log('Balance:', ethers.formatEther(balance), 'ROSE');

  if (balance === 0n) {
    console.error('\nERROR: Wallet has no ROSE tokens');
    console.log('Please fund your wallet with ROSE on Sapphire', network);
    process.exit(1);
  }

  console.log('\nDeploying contract...');
  
  const factory = new ethers.ContractFactory(CONTRACT_ABI, CONTRACT_BYTECODE, signer);
  const contract = await factory.deploy();
  
  console.log('Transaction hash:', contract.deploymentTransaction().hash);
  console.log('Waiting for confirmation...');
  
  await contract.waitForDeployment();
  const address = await contract.getAddress();
  
  console.log('\n===========================================');
  console.log('DEPLOYMENT SUCCESSFUL!');
  console.log('===========================================');
  console.log('Contract address:', address);
  console.log('Network:', network);
  console.log('Explorer:', `https://explorer.oasis.io/${network}/sapphire/address/${address}`);
  
  const deploymentInfo = {
    address,
    network,
    chainId,
    deployedAt: new Date().toISOString(),
    deployer: wallet.address
  };
  
  fs.writeFileSync(
    path.join(__dirname, '..', 'sapphire-deployment.json'),
    JSON.stringify(deploymentInfo, null, 2)
  );
  
  console.log('\nDeployment info saved to sapphire-deployment.json');
  console.log('\nNext steps:');
  console.log('1. Add SAPPHIRE_CONTRACT_ADDRESS to your environment variables');
  console.log('2. The backend will automatically use this contract for identity linking');
  
  return address;
}

deploy().catch(console.error);
